DockerImageBuild:
  stage: docker
  image: docker:24.0.6-git
  services:
    - name: docker:24.0.6-dind-alpine3.18
      alias: docker
  before_script:
    # Login GitLab container registry
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    # Build Docker image(latest tag)
    - docker pull $CI_REGISTRY_IMAGE:latest || true
    - docker build --network host --cache-from $CI_REGISTRY_IMAGE:latest --tag $CI_REGISTRY_IMAGE:latest .
    # Get Docker image version from Dockerfile
    - version=$(docker inspect --format='{{json .Config.Labels.version}}' $CI_REGISTRY_IMAGE:latest | sed -e 's/\"//g')
    - echo $version
    # Build Docker image(version tag)
    - docker build --tag $CI_REGISTRY_IMAGE:$version .
    # Push Docker images to GitLab container registry
    - docker push $CI_REGISTRY_IMAGE:latest
    - docker push $CI_REGISTRY_IMAGE:$version
  rules:
    # Run a job only when the Dockerfile is changed.
    - changes:
        - .gitlab/ci/docker.gitlab-ci.yml
        - Dockerfile
  interruptible: true

DangerDockerImageBuild:
  stage: docker
  image: docker:24.0.6-git
  services:
    - name: docker:24.0.6-dind-alpine3.18
      alias: docker
  before_script:
    # Login GitLab container registry
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    # Build Docker image(latest tag)
    - docker pull $CI_REGISTRY_IMAGE/danger:latest || true
    - docker build --network host --cache-from $CI_REGISTRY_IMAGE/danger:latest --tag $CI_REGISTRY_IMAGE/danger:latest -f Danger.Dockerfile .
    # Get Docker image version from Dockerfile
    - version=$(docker inspect --format='{{json .Config.Labels.version}}' $CI_REGISTRY_IMAGE/danger:latest | sed -e 's/\"//g')
    - echo $version
    # Build Docker image(version tag)
    - docker build --tag $CI_REGISTRY_IMAGE/danger:$version -f Danger.Dockerfile .
    # Push Docker images to GitLab container registry
    - docker push $CI_REGISTRY_IMAGE/danger:latest
    - docker push $CI_REGISTRY_IMAGE/danger:$version
  rules:
    # Run a job only when the Dockerfile is changed.
    - changes:
        - .gitlab/ci/docker.gitlab-ci.yml
        - Danger.Dockerfile
  interruptible: true
